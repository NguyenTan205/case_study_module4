<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Danh s√°ch ng∆∞·ªùi d√πng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
    /* Gi·ªõi h·∫°n chi·ªÅu r·ªông c·ªßa select ƒë·ªÉ kh√¥ng ƒë·∫©y n√∫t xu·ªëng d√≤ng */
    .table .form-select {
      width: auto !important;
      min-width: 140px;
    }

    /* Gi·ªØ n√∫t v√† select c√πng h√†ng */
    .table td .d-flex {
      flex-wrap: nowrap;
      align-items: center;
    }

    /* Gi√£n nh·∫π kho·∫£ng c√°ch gi·ªØa n√∫t */
    .table td .btn {
      white-space: nowrap;
    }
  </style>

</head>
<body class="bg-light">

<div class="container mt-5">
  <h2 class="text-center mb-4"><i class="bi bi-person-lines-fill"> DANH S√ÅCH NG∆Ø·ªúI D√ôNG</i></h2>

  <!-- ‚úÖ Th√¥ng b√°o -->
  <div th:if="${param.success}">
    <div class="alert alert-success text-center">‚úÖ C·∫≠p nh·∫≠t quy·ªÅn th√†nh c√¥ng!</div>
  </div>
  <div th:if="${param.successDelete}">
    <div class="alert alert-success text-center">üóëÔ∏è X√≥a ng∆∞·ªùi d√πng th√†nh c√¥ng!</div>
  </div>

  <!-- üîç Search -->
  <form th:action="@{/admin/search}" method="get" class="mb-3">
    <div class="input-group">
      <input type="text" name="search" class="form-control" placeholder="Search by name">
      <button type="submit" class="btn btn-outline-secondary">Search</button>
    </div>
  </form>

  <!-- üßæ B·∫£ng danh s√°ch -->
  <table class="table table-bordered table-hover shadow-sm">
    <thead class="table-primary">
    <tr>
      <th>No.</th>
      <th>T√™n ƒëƒÉng nh·∫≠p</th>
      <th>Quy·ªÅn hi·ªán t·∫°i</th>
      <th>Thao t√°c</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="user : ${users}">
      <td th:text="${user.id}"></td>
      <td th:text="${user.username}"></td>

      <!-- C·ªôt quy·ªÅn -->
      <td>
        <span th:text="${#strings.listJoin(userRoles[user.id], ', ')}"></span>
      </td>

      <!-- C·ªôt thao t√°c -->
      <td th:if="${!#lists.contains(userRoles[user.id], 'ROLE_ADMIN')}">
        <div class="d-flex align-items-center">
          <!-- Form c·∫≠p nh·∫≠t quy·ªÅn -->
          <form th:action="@{'/admin/updateRole/' + ${user.id}}" method="post" class="d-flex me-2">
            <select name="role" class="form-select me-2">
              <option value="ROLE_STUDENT"
                      th:selected="${#lists.contains(userRoles[user.id], 'ROLE_STUDENT')}">
                H·ªçc vi√™n
              </option>
              <option value="ROLE_TEACHER"
                      th:selected="${#lists.contains(userRoles[user.id], 'ROLE_TEACHER')}">
                Gi√°o vi√™n
              </option>
            </select>
            <button type="submit" class="btn btn-success btn-sm px-2"><i class="bi bi-pen">C·∫≠p nh·∫≠t</i></button>
          </form>
          <button type="button" class="btn btn-danger btn-sm px-3" data-bs-toggle="modal"
                  data-bs-target="#deleteModal" th:attr="data-id=${user.id}, data-name=${user.username}">
            <i class="bi bi-trash">Xo√°</i>
          </button>
        </div>
      </td>

      <!-- N·∫øu l√† admin -->
      <td th:if="${#lists.contains(userRoles[user.id], 'ROLE_ADMIN')}">
        <span class="badge bg-secondary">ADMIN</span>
      </td>
    </tr>
    </tbody>
  </table>
</div>

<!-- ‚úÖ Ph√¢n trang -->
<div class="d-flex justify-content-center mt-4">
  <ul class="pagination">

    <!-- Trang tr∆∞·ªõc -->
    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
      <a class="page-link"
         th:if="${#strings.isEmpty(search)}"
         th:href="@{/admin/users(page=${currentPage - 1})}"><i class="bi bi-arrow-left-circle"></i></a>
      <a class="page-link"
         th:if="${!#strings.isEmpty(search)}"
         th:href="@{/admin/search(search=${search}, page=${currentPage - 1})}"><i class="bi bi-arrow-left-circle"></i></a>
    </li>

    <!-- C√°c trang -->
    <li class="page-item"
        th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
        th:classappend="${i == currentPage} ? 'active'">
      <a class="page-link"
         th:if="${#strings.isEmpty(search)}"
         th:href="@{/admin/users(page=${i})}"
         th:text="${i + 1}"></a>
      <a class="page-link"
         th:if="${!#strings.isEmpty(search)}"
         th:href="@{/admin/search(search=${search}, page=${i})}"
         th:text="${i + 1}"></a>
    </li>

    <!-- Trang sau -->
    <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
      <a class="page-link"
         th:if="${#strings.isEmpty(search)}"
         th:href="@{/admin/users(page=${currentPage + 1})}"><i class="bi bi-arrow-right-circle"></i></a>
      <a class="page-link"
         th:if="${!#strings.isEmpty(search)}"
         th:href="@{/admin/search(search=${search}, page=${currentPage + 1})}"><i class="bi bi-arrow-right-circle"></i></a>
    </li>
  </ul>
</div>

<!-- N√∫t quay l·∫°i -->
<div class="text-center mt-4">
  <a th:href="@{/admin/home}" class="btn btn-outline-primary"><i class="bi bi-box-arrow-left">  Quay l·∫°i trang ch·ªß</i></a>
</div>

<!-- üóëÔ∏è Modal X√≥a -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form th:action="@{/admin/delete}" method="post">
        <div class="modal-body">
          <p>‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ng∆∞·ªùi d√πng <strong id="deleteName"></strong>?</p>
          <input type="hidden" id="deleteId" name="id">
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-danger">‚úÖ X√≥a</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‚ùå H·ªßy</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- JS x·ª≠ l√Ω modal -->
<script>
  const deleteModal = document.getElementById('deleteModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const name = button.getAttribute('data-name');
    document.getElementById('deleteName').textContent = name;
    document.getElementById('deleteId').value = id;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
